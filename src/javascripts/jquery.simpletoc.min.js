!function(a){a(window,document,window.jQuery)}(function(a,e,t){var i=[],o=[0,0,0];t.widget("mcblog.toc",{version:"1.0.0",options:{context:"body",selectors:"h1, h2, h3"},_create:function(){var a=this;a._filterSelectors(),a._generateHTML(),a._bindEvent()},_filterSelectors:function(){var a=this;i=t(a.options.context).find(a.options.selectors)},_getLevel:function(a){var e=this,i=e.options.selectors.replace(/ /g,"").toLocaleLowerCase(),o=i.split(","),s=t(a).prop("tagName").toLocaleLowerCase();return o.indexOf(s)},_generateId:function(a){var e=this,t=e._getLevel(a);if(0===t)o[0]+=1,o[1]=0,o[2]=0;else if(1===t)o[1]+=1,o[2]=0;else{if(2!==t)throw new Error("不支持元素级别超过3级");o[2]+=1}},_getId:function(a){var e=this,t=e._getLevel(a);e._generateId(a);for(var i=[],s=0;t>=s;s++)i.push(o[s]);return i},_generateHTML:function(){var e=this;$dl=t('<dl id="sideCatalog-dl"/>'),t.each(i,function(){var a=e._getId(this),i=e._getLevel(this),o=t(this);o.attr("data-anchor","anchor"+a.join("-")),t("<dd/>",{id:"sideToolbar-item-"+a.join("-"),"class":"sideCatalog-item"+(i+1),"data-unique":"anchor"+a.join("-"),"data-target":o.prop("tagName")}).append(t("<span/>",{"class":"sideCatalog-index"+(i+1)}).text(a.join("."))).append(t("<a/>",{title:o.text(),href:"#"+o.text()}).text(o.text())).append(t('<span class="sideCatalog-dot"/>')).appendTo($dl)});var o=t('<div id="sideCatalog-catalog"/>').append($dl),s=t("<div/>",{"class":"sideCatalogBg",id:"sideCatalog"}).append('<div id="sideCatalog-sidebar"><div class="sideCatalog-sidebar-top"></div><div class="sideCatalog-sidebar-bottom"></div></div><div id="sideCatalog-updown"><div title="向上翻页" class="sideCatalog-up-disable" id="sideCatalog-up"></div><div title="向下翻页" class="sideCatalog-down-enable" id="sideCatalog-down"></div></div>').append(o);t('<div class="sideToolbar" id="sideToolbar"/>').append(s).append('<a href="javascript:void(0);" id="sideCatalogBtn"></a>').appendTo("body");var d=i[i.length-1],l=t(a).height()-(t("body")[0].scrollHeight-t(d).offset().top);l>0&&t("<div/>",{height:l}).appendTo(e.options.context)},_bindEvent:function(){var o=this;t("#sideCatalog").on("click.toc","dd",function(){return o._scrollTo(t(this)),t("dd.highlight").removeClass("highlight"),t(this).addClass("highlight"),o._refreshCatalogPosition(),!1}).on("mouseenter.toc",function(){t("#sideCatalog-dl").height()>t("#sideCatalog-catalog").height()&&t("#sideCatalog-updown").show()}).on("mouseleave.toc",function(){t("#sideCatalog-updown").hide()});var s=_.throttle(function(){t("html,body").promise().done(function(){var s=t(a).scrollTop(),d=(t(a).height(),t(e).height(),t("body")[0].scrollHeight,null),l=null,n=i;n.each(function(a){var e=Math.abs(t(this).offset().top-s);if(!(null==d||d>e))return!1;d=e,l=a;var i=t(n[l]).data("anchor");t("dd").removeClass("highlight"),t('dd[data-unique="'+i+'"]').addClass("highlight")}),o._refreshCatalogPosition()})},300);t(a).scroll(s);var d=75;t("#sideCatalog-up").click(function(){return t(this).hasClass("sideCatalog-up-disable")?!1:(t("#sideCatalog-down").hasClass("sideCatalog-down-disable")&&t("#sideCatalog-down").removeClass("sideCatalog-down-disable").addClass("sideCatalog-down-enable"),void(t("#sideCatalog-dl").position().top+d>=0?(t(this).removeClass("sideCatalog-up-enable").addClass("sideCatalog-up-disable"),t("#sideCatalog-dl").animate({top:"0px"})):t("#sideCatalog-dl").animate({top:t("#sideCatalog-dl").position().top+d+"px"})))}),t("#sideCatalog-down").click(function(){return t(this).hasClass("sideCatalog-down-disable")?!1:(t("#sideCatalog-up").hasClass("sideCatalog-up-disable")&&t("#sideCatalog-up").removeClass("sideCatalog-up-disable").addClass("sideCatalog-up-enable"),void(t("#sideCatalog-dl")[0].scrollHeight-Math.abs(t("#sideCatalog-dl").position().top-d)<t("#sideCatalog-catalog").height()?(t(this).removeClass("sideCatalog-down-enable").addClass("sideCatalog-down-disable"),t("#sideCatalog-dl").animate({top:"-"+(t("#sideCatalog-dl")[0].scrollHeight-t("#sideCatalog-catalog").height()+26)+"px"})):t("#sideCatalog-dl").animate({top:t("#sideCatalog-dl").position().top-d+"px"})))}),t("#sideCatalogBtn").click(function(){var a=t(this);a.hasClass("sideCatalogBtnDisable")?(a.removeClass("sideCatalogBtnDisable"),t("#sideCatalog").css("visibility","visible")):(a.addClass("sideCatalogBtnDisable"),t("#sideCatalog").css("visibility","hidden"))})},_scrollTo:function(a){var e=a.data("unique"),i=a.data("target"),o=this;return currentDiv=t(i+'[data-anchor="'+e+'"]'),currentDiv.length?(t("html, body").promise().done(function(){t("html, body").animate({scrollTop:currentDiv.offset().top+"px"})}),o):o},_refreshCatalogPosition:function(){var a=t("dd").index(t("dd.highlight")),e=t("dd").length,i=t("#sideCatalog-dl").position().top,o=-25*(a-6);if(i>o){var s=e-a-1-6;0>s&&(o+=25*Math.abs(s))}o>0&&(o=0),0>o?t("#sideCatalog-up").removeClass("sideCatalog-up-disable").addClass("sideCatalog-up-enable"):t("#sideCatalog-up").removeClass("sideCatalog-up-enable").addClass("sideCatalog-up-disable"),t("#sideCatalog-dl").height()-Math.abs(o)>t("#sideCatalog-catalog").height()?t("#sideCatalog-down").removeClass("sideCatalog-down-disable").addClass("sideCatalog-down-enable"):t("#sideCatalog-down").removeClass("sideCatalog-down-enable").addClass("sideCatalog-down-disable"),setTimeout(function(){t("#sideCatalog-dl").animate({top:o+"px"},"fast")},0)}})});
